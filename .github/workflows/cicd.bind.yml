## bind
name: CICD - bind
on:
  push:
    branches:
      - master
      - release/*
    tags:
      - v1*
    paths:
      - 'container/base/**'
      - 'container/bind/**'
  pull_request:
    branches:
      - master
      - release/*
    tags:
      - v1*
    paths:
      - 'container/base/**'
      - 'container/bind/**'
  repository_dispatch:
    types: [ bind ]

## Rebuild
jobs:
  ######################################################################
  ## Base container
  ######################################################################
  base:
    strategy:
      matrix:
        platform: [ amd64, 386, arm64, arm/v7 ]
    name: Build ${{ github.ref }} base/${{ matrix.platform }}
    runs-on: ubuntu-latest
    env:
      CONTAINER: base
      BINFMT: "linuxkit/binfmt:v0.8"
    steps:
    - name: Check out from ${{ github.ref }}
      id: checkout
      uses: actions/checkout@v2
    - name: Run pre-build hooks
      id: hooks
      run: |
        $GITHUB_WORKSPACE/ci/hooks/pre_build $GITHUB_WORSKPACE/container/$CONTAINER/Dockerfile
    - name: Set up build environment
      id: buildenv
      run: |
        docker run --rm --privileged $BINFMT
        docker buildx create --name rootwyrm --use
    - name: Build $CONTAINER for ${{ matrix.platform }}
      run: |
        PLATFORM_TAG=$(echo ${{ matrix.platform }} | sed -e 's,/,,g')
        VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
        [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
        [ "$VERSION" == "master" ] && VERSION=latest
        [ "$VERSION" == "main" ] && VERSION=latest
        docker login -u ${{ secrest.HUB_USER }} -p ${{ secrets.HUB_TOKEN }}
        docker buildx build --platform linux/${{matrix.platform}} \
        --tag rootwyrm/dns_base:$VERSION-$PLATFORM_TAG \
        --pull --push container/$CONTAINER
  base_package:
    needs: base
    name: Package dns_base ${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out from ${{ github.ref }}
        uses: actions/checkout@v2
      - name: Install manifest-tool
        run: |
          ${GITHUB_WORKSPACE}/ci/tools/install.manifest-tool.sh
      ## Yay python3 flux
      - name: Assemble and push manifest ${{github.ref}}
        run: |
          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
          [ "$VERSION" == "master" ] && VERSION=latest
          [ "$VERSION" == "main" ] && VERSION=latest
          docker login -u ${{ secrest.HUB_USER }} -p ${{ secrets.HUB_TOKEN }}
          ${GITHUB_WORKSPACE}/ci/manifest-tool push from-args \
          --platforms linux/amd64,linux/386,linux/arm64,linux/arm/v7 \
          --template rootwyrm/dns_base:$VERSION-ARCHVARIANT \ 
          --target rootwyrm/dns_base:$VERSION
      - name: Run manifest cleaning tool
        run: |
          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
          [ "$VERSION" == "master" ] && VERSION=latest
          [ "$VERSION" == "main" ] && VERSION=latest
          for p in amd64 386 arm64 armv7; do
          ${GITHUB_WORKSPACE}/ci/tools/manifest_clean.py -u ${{ secrets.HUB_USER }} -p ${{ secrets.HUB_SECRET2 }} -c dns_base -t $VERSION-$p
          done
  ######################################################################
  ## bind
  ######################################################################
  bind:
    strategy:
      matrix:
        platform: [ amd64, 386, arm64, arm/v7 ]
    name: Build ${{ github.ref }} bind/${{ matrix.platform }}
    runs-on: ubuntu-20.04
    env:
      CONTAINER: bind
      #BINFMT: "docker.io/rootwyrm/advbinfmt:5.1.0"
      BINFMT: "linuxkit/binfmt:v0.8"
    steps:
    - name: Check out from ${{ github.ref }} 
      id: checkout
      uses: actions/checkout@v2
    - name: Run pre-build hooks
      id: hooks
      run: |
        $GITHUB_WORKSPACE/ci/hooks/pre_build $GITHUB_WORKSPACE/container/$CONTAINER/Dockerfile
    - name: Set up build environment
      id: buildenv
      run: |
        docker run --rm --privileged $BINFMT
        docker buildx create --name rootwyrm --use
    - name: Build for ${{ matrix.platform }}
      run: |
        PLATFORM_TAG=$(echo ${{ matrix.platform }} | sed -e 's,/,,g')
        VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
        [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
        [ "$VERSION" == "master" ] && VERSION=latest
        docker login -u ${{ secrets.HUB_USER }} -p ${{ secrets.HUB_TOKEN }}
        docker buildx build --platform linux/${{ matrix.platform }} \
        --tag rootwyrm/$CONTAINER:$VERSION-$PLATFORM_TAG \
        --pull --push container/$CONTAINER
  bind_package:
    needs: bind 
    name: Package bind ${{ github.ref }}
    runs-on: ubuntu-20.04
    steps:
      - name: Check out from ${{ github.ref }}
        uses: actions/checkout@v2
      - name: Install manifest-tool
        run: |
          ${GITHUB_WORKSPACE}/ci/tools/install.manifest-tool.sh
      ## Doesn't print correctly due to python3 flux. 
      - name: Assemble and push manifest ${{ github.ref }}
        run: |
          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
          [ "$VERSION" == "master" ] && VERSION=latest
          docker login -u ${{ secrets.HUB_USER }} -p ${{ secrets.HUB_TOKEN }}
          ${GITHUB_WORKSPACE}/ci/manifest-tool push from-args \
          --platforms linux/amd64,linux/386,linux/arm64,linux/arm/v7 \
          --template rootwyrm/bind:$VERSION-ARCHVARIANT \
          --target rootwyrm/bind:$VERSION
      - name: Run manifest cleaning tool
        run: |
          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
          [ "$VERSION" == "master" ] && VERSION=latest
          for p in amd64 386 arm64 armv7; do
          ${GITHUB_WORKSPACE}/ci/tools/manifest_clean.py -u ${{ secrets.HUB_USER }} -p ${{ secrets.HUB_SECRET2 }} -c bind -t $VERSION-$p
          done

# vim:ts=2:sw=2:et
