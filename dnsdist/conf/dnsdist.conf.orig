--------------------------------------------------------------------------------
-- Part of dns_docker by Phillip "RootWyrm" Jaenke
-- https://github.com/rootwyrm/dns_docker
-- 
-- dnsdist.conf
--------------------------------------------------------------------------------

------------------------------------------------------------
-- Control Socket configuration
------------------------------------------------------------
%%DNSDIST_CONTROLKEY%%
controlSocket('127.0.0.1:5199')
setConsoleACL('127.0.0.0/8')

------------------------------------------------------------
-- Listener configuration
------------------------------------------------------------
setLocal('127.0.0.1', { reusePort=true, tcpFastOpenQueueSize=64})
--addLocal('%%DNSDIST_LOCALIP4%%', { reusePort=true, tcpFastOpenQueueSize=32})
--Local Listeners

------------------------------------------------------------
-- Web server configuration
------------------------------------------------------------
webserver("%%DNSDIST_LOCALIP4%%:8053", "%%DNSDIST_PASSWD%%", "%%DNSDIST_APIKEY%%", {}, "127.0.0.0/8, 172.16.0.0/12")
webserver("%%DNSDIST_LOCALIP6%%:8053", "%%DNSDIST_PASSWD%%", "%%DNSDIST_APIKEY%%", {}, "127.0.0.0/8, 172.16.0.0/12")

------------------------------------------------------------
-- Set default ACL
------------------------------------------------------------
setACL('127.0.0.0/8')
addACL('172.16.0.0/12')

------------------------------------------------------------
-- XXX: DOH configuration goes here
------------------------------------------------------------

------------------------------------------------------------
-- Server pools
------------------------------------------------------------
-- XXX: DO NOT ALTER OR ADD TO THE "localroot" POOL!
newServer( {address="172.16.53.11:10530", pool="localroot", name="localroot", tcpFastOpen=true, qps=100000} )
-- Some reasonable public engagement servers as an example
-- DO NOT CHANGE THE HEALTH CHECK SETTINGS!

-- newServer( { address="9.9.9.9:53", pool="quad9",  name="dns9.quad9.net", qps=10, checkFunction=quad9_HealthCheck, checkInterval=120} )
-- newServer( { address="149.112.112.112:53", pool="quad9",  name="rrdns.pch.net", qps=10, checkFunction=quad9_HealthCheck, checkInterval=120} )

--function quad9_HealthCheck(qname, qtype, qclass, dh)
--	dh:setCD(true)
--	local randomName = { 'powerdns.com.', 'www.google.com.', 'www.bing.com.', 'facebook.com.', 'amazon.com.' }
--	for k in pairs(randomName) do
--		table.insert(names,k)
--	end
--	return newDNSName([math.random(#names)]), DNSQType.A, qclass
--end

------------------------------------------------------------
-- Fixed mapping
------------------------------------------------------------
-- Send our authoritative queries to local NSD
addAction("root-servers.net",   PoolAction("localroot"))
addAction("arpa",               PoolAction("localroot"))
addAction("in-addr.arpa",       PoolAction("localroot"))
addAction("ipv4only.arpa",      PoolAction("localroot"))
addAction("ip6.arpa",           PoolAction("localroot"))
addAction("ip6-servers.arpa",   PoolAction("localroot"))
addAction("mcast.net",          PoolAction("localroot"))
addAction("224.in-addr.arpa",   PoolAction("localroot"))
addAction("225.in-addr.arpa",   PoolAction("localroot"))
addAction("226.in-addr.arpa",   PoolAction("localroot"))
addAction("227.in-addr.arpa",   PoolAction("localroot"))
addAction("228.in-addr.arpa",   PoolAction("localroot"))
addAction("229.in-addr.arpa",   PoolAction("localroot"))
addAction("230.in-addr.arpa",   PoolAction("localroot"))
addAction("231.in-addr.arpa",   PoolAction("localroot"))
addAction("232.in-addr.arpa",   PoolAction("localroot"))
addAction("233.in-addr.arpa",   PoolAction("localroot"))
addAction("234.in-addr.arpa",   PoolAction("localroot"))
addAction("235.in-addr.arpa",   PoolAction("localroot"))
addAction("236.in-addr.arpa",   PoolAction("localroot"))
addAction("237.in-addr.arpa",   PoolAction("localroot"))
addAction("238.in-addr.arpa",   PoolAction("localroot"))
addAction("239.in-addr.arpa",   PoolAction("localroot"))

------------------------------------------------------------
-- Base cache settings; must set cache
------------------------------------------------------------
cache_localroot     = newPacketCache(512)
cache_authoritative = newPacketCache(4096, {numberOfShards=4})
cache_recursor      = newPacketCache(8192, {numberOfShards=8})
getPool("localroot"):setCache(cache_localroot)
getPool("authoritative"):setCache(cache_authoritative)
getPool("recursor"):setCache(cache_recursor)

------------------------------------------------------------
-- Include actions; order matters
-- Subdirectories 
------------------------------------------------------------
includeDirectory('/usr/local/etc/conf.d')
includeDirectory('/usr/local/etc/lua')
includeDirectory('/usr/local/etc/maps')

-- vim:ft=lua
